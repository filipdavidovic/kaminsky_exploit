'''
    Module for checking whether the victim nameserver implements incremental TXID
'''
from scapy.all import IP, UDP, DNS, DNSQR, sr1
from random import randint

import utils

# TODO: this requires that the user inputs a nameserver that he controls, and is authoritative for a domain
# then he can send a couple queries from a client and wait for the recursive query on his nameserver
def isIdIncremental(args):
    # set args.incremental to True or False depending on whether the TXID is incremental
    # if the TXID is incremental we can find it out in the following way:
    #   DNS client asks for a test domain of which he knows he's authoritative for (at one point the DNS server will ask his nameserver for the IP)
    #   normal recursive search happens
    #   DNS server asks his nameserver for the IP
    #   we can check the source port and the TXID of this packet
    # if the TXID is incremental we know which TXID will be for the next packet

    pkt = IP(dst=googleNameserver, ttl=128) / UDP(sport=utils.getRandomPort()) / DNS(id=TXID, rd=1, qd=DNSQR(qname="google.com", qtype="A"))
    ans = sr1(pkt, timeout=100)
    print ans
    # pkts = [pkt for x in range(6)]
    # ans, uans = sr(pkts, timeout=100) # default timeout is absurd
    # for x in ans[UDP]:
    #     print x[1][DNS].id
